{% extends "base.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Profile Header -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-8 mb-8">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center gap-6">
                <div class="h-24 w-24 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-400 text-4xl font-bold">
                    {{ user.username[0].upper() }}
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">{{ user.username }}</h1>
                    <p class="text-gray-500 dark:text-gray-400 flex items-center gap-2">
                        <i class="fas fa-envelope"></i> {{ user.email }}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-8 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">
                        {{ user.total_points }}
                    </div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total Points</p>
                </div>
                <div class="h-12 w-px bg-gray-200 dark:bg-gray-600"></div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-yellow-500">
                        <i class="fas fa-crown"></i>
                    </div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Rank</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Current Streak -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Current Streak</h3>
                <div class="p-2 bg-orange-100 dark:bg-orange-900/30 rounded-lg text-orange-600 dark:text-orange-400">
                    <i class="fas fa-fire text-xl"></i>
                </div>
            </div>
            <div class="flex items-baseline gap-2">
                <span class="text-4xl font-bold text-gray-900 dark:text-white">{{ user.current_streak }}</span>
                <span class="text-gray-500 dark:text-gray-400">days</span>
            </div>
        </div>

        <!-- Longest Streak -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Longest Streak</h3>
                <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
                    <i class="fas fa-trophy text-xl"></i>
                </div>
            </div>
            <div class="flex items-baseline gap-2">
                <span class="text-4xl font-bold text-gray-900 dark:text-white">{{ user.longest_streak }}</span>
                <span class="text-gray-500 dark:text-gray-400">days</span>
            </div>
        </div>

        <!-- Achievements Count -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Achievements</h3>
                <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400">
                    <i class="fas fa-medal text-xl"></i>
                </div>
            </div>
            <div class="flex items-baseline gap-2">
                <span class="text-4xl font-bold text-gray-900 dark:text-white" id="achievement-count">{{ user.achievements|length }}</span>
                <span class="text-gray-500 dark:text-gray-400">unlocked</span>
            </div>
        </div>
    </div>

    <!-- Achievements Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="fas fa-award text-indigo-500"></i> Achievements
            </h2>
        </div>
        
        <div class="p-6">
            <!-- Earned Achievements -->
            <div class="mb-8">
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">Unlocked</h3>
                <div id="earned-achievements" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Available Achievements -->
            <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">Available to Unlock</h3>
                <div id="available-achievements" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadAchievements() {
        try {
            // Load user profile with achievements
            const profileResponse = await fetch('/api/profile');
            const profile = await profileResponse.json();

            // Load all available achievements
            const allAchievementsResponse = await fetch('/api/achievements');
            const allAchievements = await allAchievementsResponse.json();

            // Get earned achievement IDs
            const earnedIds = new Set(profile.achievements.map(a => a.id));

            // Separate earned and available achievements
            const earnedContainer = document.getElementById('earned-achievements');
            const availableContainer = document.getElementById('available-achievements');

            earnedContainer.innerHTML = '';
            availableContainer.innerHTML = '';

            // Display earned achievements
            if (profile.achievements.length === 0) {
                earnedContainer.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-dashed border-gray-300 dark:border-gray-600">
                        <i class="fas fa-lock mb-2 text-2xl"></i>
                        <p>No achievements unlocked yet. Keep working!</p>
                    </div>`;
            } else {
                profile.achievements.forEach(achievement => {
                    const card = createAchievementCard(achievement, true);
                    earnedContainer.appendChild(card);
                });
            }

            // Display available achievements
            const available = allAchievements.filter(a => !earnedIds.has(a.id));
            if (available.length === 0) {
                availableContainer.innerHTML = `
                    <div class="col-span-full text-center py-8 text-green-500 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-lg border border-dashed border-green-200 dark:border-green-800">
                        <i class="fas fa-check-circle mb-2 text-2xl"></i>
                        <p>All achievements unlocked! ğŸ‰</p>
                    </div>`;
            } else {
                available.forEach(achievement => {
                    const card = createAchievementCard(achievement, false);
                    availableContainer.appendChild(card);
                });
            }
        } catch (error) {
            console.error('Error loading achievements:', error);
        }
    }

    function getIconHtml(iconName) {
        const iconMap = {
            'TARGET': 'ğŸ¯',
            'CHECK': 'âœ…',
            'FIRE': 'ğŸ”¥',
            'BOOK': 'ğŸ“š',
            'SWORD': 'âš”ï¸',
            'STAR': 'ğŸŒŸ',
            'CLOCK': 'â°',
            '100': 'ğŸ’¯',
            'GEM': 'ğŸ’'
        };
        return iconMap[iconName] || 'ğŸ†';
    }

    function createAchievementCard(achievement, earned) {
        const card = document.createElement('div');
        
        if (earned) {
            card.className = 'bg-gradient-to-br from-indigo-50 to-white dark:from-indigo-900/20 dark:to-gray-800 rounded-lg p-4 border border-indigo-100 dark:border-indigo-800 shadow-sm hover:shadow-md transition-shadow';
        } else {
            card.className = 'bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 opacity-75 hover:opacity-100 transition-opacity';
        }

        const earnedDate = earned && achievement.earned_at ? new Date(achievement.earned_at).toLocaleDateString() : '';

        card.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="text-3xl bg-white dark:bg-gray-700 rounded-full w-12 h-12 flex items-center justify-center shadow-sm border border-gray-100 dark:border-gray-600">
                    ${getIconHtml(achievement.icon)}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-2">
                        <h4 class="font-bold text-gray-900 dark:text-white truncate">${achievement.name}</h4>
                        ${earned ? '<i class="fas fa-check-circle text-green-500 text-sm mt-1"></i>' : ''}
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 line-clamp-2">${achievement.description}</p>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${earned ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400'}">
                            <i class="fas fa-star mr-1"></i> ${achievement.points} pts
                        </span>
                        ${earned ? `<span class="text-xs text-gray-500 dark:text-gray-500">${earnedDate}</span>` : ''}
                    </div>
                </div>
            </div>
        `;

        return card;
    }

    // Load achievements on page load
    document.addEventListener('DOMContentLoaded', loadAchievements);
</script>
{% endblock %}
