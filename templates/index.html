{% extends "base.html" %}

{% block title %}Assignment Tracker{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 dark:text-white">Assignment Tracker</h1>

        <!-- Add Assignment Form -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 dark:text-white">Add New Assignment</h2>
            <form action="/assignments" method="post" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Assignment Name</label>
                    <input type="text" id="name" name="name" required
                           class="mt-1 block w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="due_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Due Date & Time</label>
                    <input type="datetime-local" id="due_date" name="due_date" required
                           class="mt-1 block w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 dark:[color-scheme:dark]">
                    <script>
                        // Set min to current date/time to prevent past dates
                        document.addEventListener('DOMContentLoaded', function() {
                            const now = new Date();
                            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                            document.getElementById('due_date').min = now.toISOString().slice(0, 16);
                        });
                    </script>
                </div>

                <div>
                    <label for="estimated_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Estimated Time</label>
                    <div class="flex gap-2">
                        <input type="number" id="estimated_time" name="estimated_time" min="1" required
                               class="mt-1 block w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500">
                        <select id="time_unit" class="mt-1 rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea id="description" name="description" rows="3"
                              class="mt-1 block w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                
                <button type="submit" 
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Add Assignment
                </button>
            </form>
        </div>
        
        <!-- Assignments List -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4 dark:text-white">Your Assignments</h2>
            {% if assignments %}
                <div class="space-y-4">
                    {% for assignment in assignments %}
                        <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
                            <div class="flex justify-between items-start gap-4">
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium dark:text-white">{{ assignment.name }}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Due: {{ assignment.due_date.strftime('%B %d, %Y at %-I:%M %p') }}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Estimated Time: {{ assignment.estimated_time }} minutes</p>
                                    {% if assignment.description %}
                                        <p class="mt-2 text-gray-700 dark:text-gray-300">{{ assignment.description }}</p>
                                    {% endif %}

                                    <!-- Progress Bar -->
                                    {% set progress = (assignment.time_spent / assignment.estimated_time * 100) if assignment.estimated_time > 0 else 0 %}
                                    {% set progress = [progress, 100]|min %}
                                    <div class="mt-3">
                                        <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-1">
                                            <span>Progress: {{ "%.0f"|format(progress) }}%</span>
                                            <span>{{ assignment.time_spent }}/{{ assignment.estimated_time }} min</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                            <div class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300"
                                                 style="width: {{ progress }}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0">
                                    <button type="button"
                                            class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 btn-edit"
                                            data-id="{{ assignment.id }}">
                                        Edit
                                    </button>
                                    <button type="button"
                                            class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 btn-delete"
                                            data-id="{{ assignment.id }}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-4">No assignments yet. Add one above!</p>
            {% endif %}
        </div>
    </div>

    <!-- Progress Update Modal -->
    <div id="progress-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Update Progress</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">How much did you complete during this session?</p>

                <div class="mb-4">
                    <p id="progress-assignment-name" class="font-medium text-gray-900 dark:text-white mb-2"></p>
                    <p id="progress-session-duration" class="text-sm text-gray-600 dark:text-gray-400 mb-4"></p>
                </div>

                <div class="mb-6">
                    <label for="progress-slider" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Progress: <span id="progress-value">0</span> minutes (<span id="progress-percent">0</span>%)
                    </label>
                    <input type="range" id="progress-slider" min="0" max="100" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mt-1">
                        <span>0 min</span>
                        <span id="progress-max">0 min</span>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="progress-cancel" class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500">
                        Cancel
                    </button>
                    <button id="progress-save" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                        Save Progress
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
  // If global functions exist, we'll call them; otherwise we have safe fallbacks.
  document.addEventListener('DOMContentLoaded', function () {
    // Handle time unit conversion and form submission
    const form = document.querySelector('form[action="/assignments"]');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent default form submission

        const timeInput = document.getElementById('estimated_time');
        const timeUnit = document.getElementById('time_unit');
        let estimatedTime = parseInt(timeInput.value);

        if (timeUnit.value === 'hours') {
          estimatedTime = estimatedTime * 60; // Convert hours to minutes
        }

        // Create FormData
        const formData = new FormData();
        formData.append('name', document.getElementById('name').value);
        formData.append('due_date', document.getElementById('due_date').value);
        formData.append('estimated_time', estimatedTime);
        formData.append('description', document.getElementById('description').value);
        formData.append('priority', 2); // Default priority

        try {
          const response = await fetch('/assignments', {
            method: 'POST',
            body: formData
          });

          if (response.redirected || response.status === 303) {
            // Success - reload the page
            window.location.reload();
          } else if (response.status === 400) {
            // Duplicate assignment error
            const data = await response.json();
            alert(data.error);
          } else {
            const data = await response.json();
            alert(data.error || 'An error occurred while creating the assignment');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred while creating the assignment');
        }
      });
    }

    // Edit buttons
    document.querySelectorAll('.btn-edit').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const id = parseInt(this.dataset.id, 10);
        if (typeof window.editAssignment === 'function') {
          window.editAssignment(id);
        } else {
          // Fallback: navigate to an edit page if your app supports it
          window.location.href = `/assignments/${id}/edit`;
        }
      });
    });

    // Delete buttons
    document.querySelectorAll('.btn-delete').forEach(function (btn) {
      btn.addEventListener('click', async function () {
        const id = parseInt(this.dataset.id, 10);
        if (typeof window.deleteAssignment === 'function') {
          window.deleteAssignment(id);
        } else {
          // Fallback: simple DELETE fetch (adjust route if your API differs)
          if (confirm('Delete this assignment?')) {
            try {
              const res = await fetch(`/assignments/${id}`, { method: 'DELETE' });
              if (res.ok) {
                location.reload();
              } else {
                const err = await res.json().catch(() => ({}));
                alert(err.detail || 'Delete failed.');
              }
            } catch (e) {
              alert('Delete failed.');
            }
          }
        }
      });
    });
  });
</script>
<script src="{{ url_for('static', path='/js/progress_tracker.js') }}"></script>
{% endblock %}
