{% extends "base.html" %}

{% block title %}Assignment Tracker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<style>
    .flatpickr-calendar {
        font-family: 'Inter', sans-serif;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .flatpickr-day.selected {
        background: #4f46e5;
        border-color: #4f46e5;
    }
</style>
{% endblock %}

{% block content %}
    <div class="max-w-[95%] mx-auto px-6 py-10">
        <div class="flex flex-col lg:flex-row gap-10">
            <!-- Left Sidebar: Add Assignment -->
            <div class="lg:w-1/3 xl:w-1/4">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl sticky top-8">
                    <div class="flex items-center gap-4 mb-8">
                        <div class="p-3 bg-indigo-100 dark:bg-indigo-900 rounded-xl">
                            <i class="fas fa-plus text-2xl text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">New Assignment</h2>
                    </div>
                    
                    <form action="/assignments" method="post" class="space-y-6">
                        <div>
                            <label for="name" class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-2">Assignment Name</label>
                            <input type="text" id="name" name="name" required placeholder="e.g., Math Homework"
                                   class="w-full px-4 py-3 rounded-xl border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-lg">
                        </div>

                        <div>
                            <label for="due_date" class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-2">Due Date</label>
                            <div class="relative">
                                <input type="text" id="due_date" name="due_date" required placeholder="Select date and time"
                                       class="w-full px-4 py-3 rounded-xl border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-lg cursor-pointer">
                                <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                    <i class="far fa-calendar-alt text-gray-400"></i>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="estimated_time" class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-2">Estimated Duration</label>
                            <div class="flex gap-3" x-data="{ unit: 'minutes' }">
                                <input type="number" id="estimated_time" name="estimated_time" min="1" required placeholder="30"
                                       class="w-full px-4 py-3 rounded-xl border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-lg">
                                
                                <!-- Custom Toggle for Time Unit -->
                                <div class="flex bg-gray-200 dark:bg-gray-700 rounded-xl p-1 w-48 shrink-0">
                                    <button type="button" @click="unit = 'minutes'" 
                                            :class="{'bg-white dark:bg-gray-600 shadow text-indigo-600 dark:text-indigo-400': unit === 'minutes', 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200': unit !== 'minutes'}" 
                                            class="flex-1 py-2 px-2 rounded-lg text-sm font-bold transition-all">
                                        Mins
                                    </button>
                                    <button type="button" @click="unit = 'hours'" 
                                            :class="{'bg-white dark:bg-gray-600 shadow text-indigo-600 dark:text-indigo-400': unit === 'hours', 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200': unit !== 'hours'}" 
                                            class="flex-1 py-2 px-2 rounded-lg text-sm font-bold transition-all">
                                        Hours
                                    </button>
                                    <input type="hidden" id="time_unit" name="time_unit" :value="unit">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="description" class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-2">Description (Optional)</label>
                            <textarea id="description" name="description" rows="4" placeholder="Add details..."
                                      class="w-full px-4 py-3 rounded-xl border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-lg"></textarea>
                        </div>
                        
                        <button type="submit" 
                                class="w-full flex justify-center items-center gap-3 py-4 px-6 border border-transparent rounded-xl shadow-md text-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all transform hover:scale-[1.02]">
                            <i class="fas fa-plus-circle text-xl"></i>
                            Add Assignment
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Right Content: Assignments List -->
            <div class="lg:w-2/3 xl:w-3/4">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-green-100 dark:bg-green-900 rounded-xl">
                                <i class="fas fa-tasks text-2xl text-green-600 dark:text-green-400"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Your Assignments</h2>
                        </div>
                        <span class="px-4 py-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-full text-base font-semibold">
                            {{ assignments|length }} Active
                        </span>
                    </div>

                    {% if assignments %}
                        <div class="divide-y divide-gray-200 dark:divide-gray-700">
                            {% for assignment in assignments %}
                                <div class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors group">
                                    <div class="flex justify-between items-start gap-4">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-3 mb-2">
                                                <h3 class="text-lg font-bold text-gray-900 dark:text-white truncate">{{ assignment.name }}</h3>
                                                {% if assignment.priority == 1 %}
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">High</span>
                                                {% elif assignment.priority == 2 %}
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Medium</span>
                                                {% else %}
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Low</span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400 mb-3">
                                                <div class="flex items-center gap-1.5">
                                                    <i class="far fa-calendar-alt text-indigo-500"></i>
                                                    {% if assignment.due_date %}
                                                        {{ assignment.due_date.strftime('%b %d, %I:%M %p') }}
                                                    {% else %}
                                                        No Date
                                                    {% endif %}
                                                </div>
                                                <div class="flex items-center gap-1.5">
                                                    <i class="far fa-clock text-indigo-500"></i>
                                                    {% if assignment.estimated_time %}
                                                        {% if assignment.estimated_time >= 60 %}
                                                            {{ (assignment.estimated_time // 60) }}h {{ (assignment.estimated_time % 60) }}m
                                                        {% else %}
                                                            {{ assignment.estimated_time }}m
                                                        {% endif %}
                                                    {% else %}
                                                        0m
                                                    {% endif %}
                                                </div>
                                            </div>

                                            {% if assignment.description %}
                                                <p class="text-gray-600 dark:text-gray-400 text-sm mb-4 line-clamp-2">{{ assignment.description }}</p>
                                            {% endif %}

                                            <!-- Progress Bar -->
                                            {% set progress = (assignment.time_spent / assignment.estimated_time * 100) if assignment.estimated_time > 0 else 0 %}
                                            {% set progress = [progress, 100]|min %}
                                            <div class="relative pt-1">
                                                <div class="flex mb-2 items-center justify-between">
                                                    <div>
                                                        <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-200 dark:text-indigo-200 dark:bg-indigo-900">
                                                            Progress
                                                        </span>
                                                    </div>
                                                    <div class="text-right">
                                                        <span class="text-xs font-semibold inline-block text-indigo-600 dark:text-indigo-400">
                                                            {{ "%.0f"|format(progress) }}%
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-indigo-200 dark:bg-gray-700">
                                                    <div style="width:{{ progress }}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-500 transition-all duration-500"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button type="button"
                                                    class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg dark:text-indigo-400 dark:hover:bg-gray-700 transition-colors btn-edit"
                                                    data-id="{{ assignment.id }}" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button"
                                                    class="p-2 text-red-600 hover:bg-red-50 rounded-lg dark:text-red-400 dark:hover:bg-gray-700 transition-colors btn-delete"
                                                    data-id="{{ assignment.id }}" title="Delete">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="flex flex-col items-center justify-center py-16 px-4 text-center">
                            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-full mb-4">
                                <i class="fas fa-clipboard-check text-4xl text-gray-400 dark:text-gray-500"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-1">No assignments yet</h3>
                            <p class="text-gray-500 dark:text-gray-400 max-w-sm">
                                Get started by adding your first assignment using the form on the left.
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Assignment Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full max-w-md shadow-2xl rounded-xl bg-white dark:bg-gray-800 transform transition-all">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 mb-4">
                    <i class="fas fa-edit text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Edit Assignment</h3>
            </div>

            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-assignment-id">
                
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                    <textarea id="edit-description" rows="3" 
                        class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500 transition-colors"></textarea>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label for="edit-progress" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Progress</label>
                        <span class="text-sm font-bold text-indigo-600 dark:text-indigo-400">
                            <span id="edit-progress-value">0</span>%
                        </span>
                    </div>
                    <input type="range" id="edit-progress" min="0" max="100" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-indigo-600">
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" id="edit-cancel" class="flex-1 px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium shadow-lg shadow-indigo-500/30 transition-all transform hover:scale-[1.02]">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Progress Update Modal -->
    <div id="progress-modal" class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full max-w-md shadow-2xl rounded-xl bg-white dark:bg-gray-800 transform transition-all">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 dark:bg-indigo-900 mb-4">
                    <i class="fas fa-chart-line text-indigo-600 dark:text-indigo-400 text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Update Progress</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">How much did you complete during this session?</p>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 mb-6">
                <p id="progress-assignment-name" class="font-semibold text-gray-900 dark:text-white text-center mb-1"></p>
                <p id="progress-session-duration" class="text-sm text-indigo-600 dark:text-indigo-400 text-center font-medium"></p>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <label for="progress-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        Progress Added
                    </label>
                    <span class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
                        <span id="progress-value">0</span><span class="text-sm font-normal text-gray-500 ml-1">min</span>
                    </span>
                </div>
                
                <input type="range" id="progress-slider" min="0" max="100" value="0"
                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-indigo-600">
                
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-2">
                    <span>0 min</span>
                    <span id="progress-max">0 min</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="progress-cancel" class="flex-1 px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors">
                    Cancel
                </button>
                <button id="progress-save" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium shadow-lg shadow-indigo-500/30 transition-all transform hover:scale-[1.02]">
                    Save Progress
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
  // If global functions exist, we'll call them; otherwise we have safe fallbacks.
  document.addEventListener('DOMContentLoaded', function () {
    // Handle time unit conversion and form submission
    const form = document.querySelector('form[action="/assignments"]');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent default form submission

        const timeInput = document.getElementById('estimated_time');
        const timeUnit = document.getElementById('time_unit');
        let estimatedTime = parseInt(timeInput.value);

        if (timeUnit.value === 'hours') {
          estimatedTime = estimatedTime * 60; // Convert hours to minutes
        }

        // Create FormData
        const formData = new FormData();
        formData.append('name', document.getElementById('name').value);
        formData.append('due_date', document.getElementById('due_date').value);
        formData.append('estimated_time', estimatedTime);
        formData.append('description', document.getElementById('description').value);
        formData.append('priority', 2); // Default priority

        try {
          const response = await fetch('/assignments', {
            method: 'POST',
            body: formData
          });

          if (response.redirected || response.status === 303) {
            // Success - reload the page
            window.location.reload();
          } else if (response.status === 400) {
            // Duplicate assignment error
            const data = await response.json();
            alert(data.error);
          } else {
            const data = await response.json();
            alert(data.error || 'An error occurred while creating the assignment');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred while creating the assignment');
        }
      });
    }

    // Edit buttons
    document.querySelectorAll('.btn-edit').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const id = parseInt(this.dataset.id, 10);
        if (typeof window.editAssignment === 'function') {
          window.editAssignment(id);
        } else {
          // Fallback: navigate to an edit page if your app supports it
          window.location.href = `/assignments/${id}/edit`;
        }
      });
    });

    // Delete buttons
    document.querySelectorAll('.btn-delete').forEach(function (btn) {
      btn.addEventListener('click', async function () {
        const id = parseInt(this.dataset.id, 10);
        if (typeof window.deleteAssignment === 'function') {
          window.deleteAssignment(id);
        } else {
          // Fallback: simple DELETE fetch (adjust route if your API differs)
          if (confirm('Delete this assignment?')) {
            try {
              const res = await fetch(`/assignments/${id}`, { method: 'DELETE' });
              if (res.ok) {
                location.reload();
              } else {
                const err = await res.json().catch(() => ({}));
                alert(err.detail || 'Delete failed.');
              }
            } catch (e) {
              alert('Delete failed.');
            }
          }
        }
      });
    });
  });
</script>
<script src="{{ url_for('static', path='/js/assignments.js') }}?v={{ range(1, 10000) | random }}"></script>
<script src="{{ url_for('static', path='/js/progress_tracker.js') }}"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        flatpickr("#due_date", {
            enableTime: true,
            dateFormat: "Y-m-d\\TH:i", // Format matches datetime-local for backend compatibility
            altInput: true,             // Show a friendly format to user
            altFormat: "F j, Y at h:i K", // e.g. November 23, 2025 at 3:30 PM
            minDate: "today",           // Prevent past dates
            time_24hr: false,
            disableMobile: "true"       // Force the custom picker on mobile
        });
    });
</script>
{% endblock %}
